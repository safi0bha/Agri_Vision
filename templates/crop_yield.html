{% extends "layout.html" %}
{% block title %}Crop Yield ‚Äî AgriVision{% endblock %}
{% block content %}

<div class="p-6 bg-white rounded card-shadow">
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-semibold">Crop Yield Prediction</h2>
      <p class="text-sm text-gray-500">Enter field data and get an AI-estimated yield.</p>
    </div>
    <div class="text-sm text-gray-500">Model: RandomForestRegressor</div>
  </div>

  <form id="yieldForm"
        action="{{ url_for('crop_yield') }}"
        method="post"
        class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4"
        x-data="{
          rainfall: '',
          temperature: '',
          humidity: '',
          fillDemo(){
            this.rainfall = 150;
            this.temperature = 28;
            this.humidity = 65;
          }
        }">

    <div>
      <label class="text-sm">Soil Type</label>
      <select name="soil_type" class="w-full border px-3 py-2 rounded mt-1">
        <option>Alluvial</option>
        <option>Black</option>
        <option>Red</option>
        <option>Laterite</option>
        <option>Mountain</option>
        <option>Desert</option>
      </select>
    </div>

    <div>
      <label class="text-sm">Fertilizer Type</label>
      <select name="fertilizer_type" class="w-full border px-3 py-2 rounded mt-1">
        <option>Urea</option>
        <option>DAP</option>
        <option>Potash</option>
        <option>Compost</option>
        <option>Organic</option>
      </select>
    </div>

    <div>
      <label class="text-sm">Crop Type</label>
      <select name="crop_type" class="w-full border px-3 py-2 rounded mt-1">
        <option>Wheat</option>
        <option>Rice</option>
        <option>Maize</option>
        <option>Sugarcane</option>
        <option>Cotton</option>
        <option>Barley</option>
      </select>
    </div>

    <div>
      <label class="text-sm">Rainfall (mm)</label>
      <input name="rainfall" type="number" step="0.1"
             x-model="rainfall"
             placeholder="Enter rainfall"
             required
             class="w-full border px-3 py-2 rounded mt-1" />
    </div>

    <div>
      <label class="text-sm">Temperature (¬∞C)</label>
      <input name="temperature" type="number" step="0.1"
             x-model="temperature"
             placeholder="Enter temperature"
             required
             class="w-full border px-3 py-2 rounded mt-1" />
    </div>

    <div>
      <label class="text-sm">Humidity (%)</label>
      <input name="humidity" type="number" step="0.1"
             x-model="humidity"
             placeholder="Enter humidity"
             required
             class="w-full border px-3 py-2 rounded mt-1" />
    </div>

    <div class="md:col-span-3 flex gap-3 mt-4 items-center">
      <button type="submit"
              id="predictBtn"
              class="px-5 py-2 bg-green-600 text-white rounded">
        üîç Predict
      </button>

      <button type="button"
              @click="fillDemo()"
              class="px-5 py-2 border rounded hover:bg-gray-50">
        üåæ Use Demo Values
      </button>

      <div id="yieldSpinner"
           class="hidden items-center text-sm text-gray-500">
        Predicting... <span class="ml-2">‚è≥</span>
      </div>
    </div>
  </form>

  <div id="yieldResult"
       class="mt-6 hidden bg-green-50 border-l-4 border-green-600 p-4 rounded">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-sm text-gray-700">Predicted Yield</div>
        <div class="text-2xl font-bold" id="yieldValue">‚Äî</div>
        <div class="text-sm text-gray-500 mt-1" id="yieldCompare">Compared to average: ‚Äî</div>
      </div>
      <div style="width:220px">
        <canvas id="yieldChart" height="120"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const yieldForm = document.getElementById('yieldForm');
  const yieldSpinner = document.getElementById('yieldSpinner');
  const yieldResult = document.getElementById('yieldResult');
  const yieldValue = document.getElementById('yieldValue');
  const yieldCompare = document.getElementById('yieldCompare');
  let yieldChart = null;

  if(yieldForm){
    yieldForm.addEventListener('submit', function(e){
      e.preventDefault();
      yieldSpinner.classList.remove('hidden');
      const fd = new FormData(yieldForm);

      fetch(yieldForm.action, { method: 'POST', body: fd })
        .then(async res => {
          try {
            const json = await res.json();
            showYieldResult(json.prediction || json.yield || json.result);
          } catch {
            const txt = await res.text();
            const m = txt.match(/([0-9]+(?:\\.[0-9]+)?)/);
            if(m) showYieldResult(parseFloat(m[1]));
            else simulate();
          }
        })
        .catch(simulate);

      function simulate(){
        const sim = (parseFloat(fd.get('rainfall')||100)/100) *
                    (parseFloat(fd.get('temperature')||25)/25) *
                    (parseFloat(fd.get('humidity')||60)/60) * 2;
        showYieldResult(Math.round(sim*100)/100);
      }

      function showYieldResult(val){
        yieldSpinner.classList.add('hidden');
        yieldResult.classList.remove('hidden');
        yieldValue.textContent = val + ' tons/ha';
        yieldCompare.textContent = 'Compared to average: ' + (Math.round((val/3)*100)-100) + '%';

        const ctx = document.getElementById('yieldChart');
        if(ctx && typeof Chart !== 'undefined'){
          if(yieldChart) yieldChart.destroy();
          yieldChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Predicted','Average'],
              datasets: [{label: 'Yield', data: [val, 3]}]
            },
            options: {plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
          });
        }
      }
    });
  }
});
</script>

{% endblock %}
